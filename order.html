{{$cap := DB_CapCurrent true}}

{{- template "cap.html" $cap -}}
{{- if not $cap.Reached -}}
	<script src="https://www.paypal.com/sdk/js?client-id={{PayPal_ClientID}}&vault=true&currency=EUR">
	</script>

	<h2>Order</h2>
	<aside>
		<span class="icon-cell">üê∂</span>
		<div>
			Need some investment advice?
			{{Blog_PostLink "2021-05-13" "Here's a blog post that summarizes what would regularly come next in each game."}}
		</div>
		<span class="icon-cell">üê∂</span>
	</aside>
	<aside>
		<span></span>
		<form action="/thankyou" method="post">
			<label>
				Name (leave blank to stay anonymous)
			</label>
			<input type="text" id="cust-name">
			<label>
				URL (optional, will turn your name into a link)
			</label>
			<input type="text" id="cust-url">
			<label>
				This contribution should go towards‚Ä¶
			</label>
			<select id="metric" onchange="handleSelect(this.options[this.selectedIndex])">
				<option>Anything (including tooling)</option>
				<option>Reverse-engineering</option>
				<option>Position independence</option>
				<option>Stable English translation patches (on PC-98)</option>
				<option data-info='Requires 100% position independence of the game(s) in question, as well as all text-related code to be reverse-engineered. If no "anything" pushes are part of the backlog, this order will be put towards reaching these prerequisites.' data-goal-mandatory>Multilingual translation support (on PC-98)</option>
				<option data-goal-mandatory>Replay support (on PC-98)</option>
				<option data-info="Requires 100% position independence of the game(s) in question." data-goal-mandatory>Increasing portability</option>
				<option data-info="Requires the 16-bit build system to be completed, delivery will be delayed until that point.">Easier verification against original binaries</option>
				<option>Reconstructing the original installers</option>
				<option data-info="Will be more efficient after 100% position independence of the game(s) in question, but definitely possible before." data-goal-mandatory>Compatibility with pre-386 PC-98 models</option>
				<option>Improving the website</option>
				<option>Build server experiments</option>
				<option>Something else?</option>
			</select>
			<label>
				Any specific game or aspect?
			</label>
			<input type="text" id="goal" onInput="this.reportValidity()">
			<aside id="info" class="info" style="display: none;">
				<span class="icon-cell">‚ÑπÔ∏è</span>
				<p id="info_text"></p>
				<span class="icon-cell">‚ÑπÔ∏è</span>
			</aside>
			<label>
				This is a‚Ä¶
			</label>
			<div>
				<input type="radio" id="onetime" onChange="onCycle()" name="cycle" value="onetime" checked>
				<label for="onetime">‚Ä¶ one-time contribution</label>
			</div>
			<div>
				<input type="radio" id="monthly" onChange="onCycle()" name="cycle" value="monthly">
				<label for="monthly">‚Ä¶ monthly contribution</label>
			</div>
			<div>
				of
				<input id="amount" type="number" max="{{$cap.FreeEuros}}">
				<span class="amount">‚Ç¨</span>
			</div>
			<div>
				that will pay for
				<span id="push_amount" data-price="{{$cap.PushPrice}}"></span>
				<span id="push_noun"></span>,
				not including special offers.
			</div>
			<div id="paypal-button-container"></div>
			<div id="error" hidden></div>
		</form>
		<span></span>
	</aside>
	<script src="{{call $.StaticFileURL "paypal.js"}}"></script>
	<aside>
		<span class="icon-cell">‚ùì</span>
		<div>
			Questions? Problems?
			<script>document.write(HTMLSupportMail());</script>.
		</div>
		<span class="icon-cell">‚ùì</span>
	</aside>

	<script>
		const metric = document.getElementById("metric");
		const goal = document.getElementById("goal");
		const info = document.getElementById("info");
		const info_text = document.getElementById("info_text");

		function handleSelect(option) {
			const goal_mandatory = option.getAttribute("data-goal-mandatory");
			const message = option.getAttribute("data-info");
			if(message) {
				metric.classList.add("info");
				info_text.textContent = message;
				info.style.display = null;
			} else {
				metric.classList.remove("info");
				info.style.display = "none";
			}

			goal.required = (goal_mandatory !== null);
			goal.reportValidity();
		}
	</script>
{{end}}
