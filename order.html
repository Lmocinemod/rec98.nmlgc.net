{{$cap := DB_CapCurrent true}}

{{- template "cap.html" $cap -}}
{{- if not $cap.Reached -}}
	<script src="https://www.paypal.com/sdk/js?client-id={{PayPal_ClientID}}&vault=true&currency=EUR">
	</script>

	<h2>Order</h2>
	<aside>
		<span class="icon-cell">üê∂</span>
		<div>
			Need some investment advice?
			{{Blog_PostLink "2021-05-13" "Here's a blog post that summarizes what would regularly come next in each game."}}
		</div>
		<span class="icon-cell">üê∂</span>
	</aside>
	<aside>
		<span></span>
		<form action="/thankyou" method="post">
			<label>
				Name (leave blank to stay anonymous)
			</label>
			<input type="text" id="cust-name">
			<label>
				URL (optional, will turn your name into a link)
			</label>
			<input type="text" id="cust-url">
			<label>
				This contribution should go towards‚Ä¶
			</label>
			<select id="metric" onchange="handleSelect(this.options[this.selectedIndex])">
				<option>Anything (including tooling)</option>
				<option>Reverse-engineering</option>
				<option>Position independence</option>
				<option>Stable English translation patches (on PC-98)</option>
				<option data-info='Involves complete UTF-8 font rendering support, no shortcuts for languages with just a few non-ASCII characters will be included. Requires 100% position independence of the game(s) in question, as well as all text-related code to be reverse-engineered. If the backlog contains no other pushes which could be used to reach these prerequisites, I will use this order to cover them.' data-goal-mandatory>Multilingual translation support (on PC-98)</option>
				<option data-info="<ul>
					<li>Please specify which game(s) would be most important to you.</li>
					<li>Requires all movement-related code of the games in question to be reverse-engineered. If the backlog contains no other pushes which could cover that code, I will use this order to cover them.</li>
					<li>As replays are critical infrastructure, this will <i>not</i> require 100% position independence, and be implemented in an <span class='hovertext' title='That is, as a TSR with a minimal amount of hooks in original game code.'>easily diffable way</span> even for games where 100% PI has been reached.</li>
				</ul>" data-goal-mandatory>Replay support (on PC-98)</option>
				<option data-info="Please specify which game(s) would be most important to you. Will consist of the following steps, in order:<ol>
					<li>Decompilations of ZUN's hand-written ASM</li>
					<li>Building a PC-98 abstraction interface in C++ and routing all the game's hardware access through it. Ports to generic 640√ó400√ó16-color framebuffers, other retro systems with hardware sprites, or headless servers with no graphical output, would then only reimplement that interface, and don't need to touch any game code.</li>
					<li>Getting rid of master.lib, PiLoad, and SPRITE16</li>
				</ol>All new code will make appropriate use of the C++ language features available in Turbo C++. Requires 100% position independence of the game(s) in question, as they will continue to run on PC-98 hardware during the entire process, perhaps even at higher performance. Does <i>not</i> imply a port to any specific system; these can be ordered separately once they become realistic." data-goal-mandatory>Portability to non-PC-98 systems</option>
				<option data-info="Requires the 16-bit build system to be completed, delivery will be delayed until that point.">Easier verification against original binaries</option>
				<option>Reconstructing the original installers</option>
				<option data-info="Please specify which game(s) would be most important to you. Will be more efficient after that game reached 100% position independence, but definitely possible before. No guarantees that it will actually <i>perform</i> well on such old systems, though!" data-goal-mandatory>Compatibility with pre-386 PC-98 models</option>
				<option>Improving the website</option>
				<option>Build server experiments</option>
				<option>Something else?</option>
			</select>
			<label>
				Any specific game or aspect?
			</label>
			<input type="text" id="goal" onInput="this.reportValidity()">
			<aside id="info" class="info" style="display: none;">
				<span class="icon-cell">‚ÑπÔ∏è</span>
				<p id="info_text"></p>
				<span class="icon-cell">‚ÑπÔ∏è</span>
			</aside>
			<label>
				This is a‚Ä¶
			</label>
			<div>
				<input type="radio" id="onetime" onChange="onCycle()" name="cycle" value="onetime" checked>
				<label for="onetime">‚Ä¶ one-time contribution</label>
			</div>
			<div>
				<input type="radio" id="monthly" onChange="onCycle()" name="cycle" value="monthly">
				<label for="monthly">‚Ä¶ monthly contribution</label>
			</div>
			<div>
				of
				<input id="amount" type="number" max="{{$cap.FreeEuros}}">
				<span class="amount">‚Ç¨</span>
			</div>
			<div>
				that will pay for
				<span id="push_amount" data-price="{{$cap.PushPrice}}"></span>
				<span id="push_noun"></span>,
				not including special offers.
			</div>
			<div id="paypal-button-container"></div>
			<div id="error" hidden></div>
		</form>
		<span></span>
	</aside>
	<script src="{{call $.StaticFileURL "paypal.js"}}"></script>
	<aside>
		<span class="icon-cell">‚ùì</span>
		<div>
			Questions? Problems?
			<script>document.write(HTMLSupportMail());</script>.
		</div>
		<span class="icon-cell">‚ùì</span>
	</aside>

	<script>
		const metric = document.getElementById("metric");
		const goal = document.getElementById("goal");
		const info = document.getElementById("info");
		const info_text = document.getElementById("info_text");

		function handleSelect(option) {
			const goal_mandatory = option.getAttribute("data-goal-mandatory");
			const message = option.getAttribute("data-info");
			if(message) {
				metric.classList.add("info");
				info_text.innerHTML = message;
				info.style.display = null;
			} else {
				metric.classList.remove("info");
				info.style.display = "none";
			}

			goal.required = (goal_mandatory !== null);
			goal.reportValidity();
		}
	</script>
{{end}}
